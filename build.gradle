/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Scala library project to get you started.
 * For more details take a look at the Scala plugin chapter in the Gradle
 * User Manual available at https://docs.gradle.org/5.2/userguide/scala_plugin.html
 */

plugins {
    // Apply the scala plugin to add support for Scala
    id 'scala'
    // Apply the scalapb gradle plugin to add support for ScalaPB compilation
    id "com.charlesahunt.scalapb" version "1.2.4"
}

ext {
    scalapb_relTargetDir = "src/main/scala/spn_compiler/scalapb_temp"
    scalapb_absTargetDir = project.getProjectDir().absolutePath + "/" + scalapb_relTargetDir
}

scalapbConfig {
    // This is somewhat hacky, since this plugin deletes(!) the target directory
    // (Which would be all our Scala sources)
    // The compiled files will be moved one directory-level up afterwards
    // Thus, allowing a correct package structure
    targetDir = project.ext.scalapb_relTargetDir
    // embeddedProtoc = true // Might be useful for further troubleshooting -- if necessary
    protocVersion = "-v371"
    projectProtoSourceDir = "src/main/protobuf"
}

repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
    jcenter()
}

dependencies {
    // Use Scala 2.12 in our library project
    implementation 'org.scala-lang:scala-library:2.12.8'

    // Use Scalatest for testing our library
    testImplementation 'junit:junit:4.12'
    testImplementation 'org.scalatest:scalatest_2.12:3.0.5'

    // Need scala-xml at test runtime
    testRuntimeOnly 'org.scala-lang.modules:scala-xml_2.12:1.1.1'

    // FastParse Library for fast parsers
    // https://mvnrepository.com/artifact/com.lihaoyi/fastparse
    compile group: 'com.lihaoyi', name: 'fastparse_2.12', version: '2.1.0'

    // Play ScalaJSON
    // https://www.playframework.com/documentation/2.6.x/ScalaJson
    compile group: 'com.typesafe.play', name: 'play-json_2.12', version: '2.6.10'

    // scopt command line parsing
    // https://github.com/scopt/scopt
    compile group: 'com.github.scopt', name: 'scopt_2.12', version: '4.0.0-RC2'

    // https://mvnrepository.com/artifact/org.wvlet.airframe/airframe-log
    compile group: 'org.wvlet.airframe', name: 'airframe-log_2.12', version: '19.4.0'

    // ScalaPB: Scala Protocol Buffer Compiler
    // https://scalapb.github.io/
    // NOTE: As of now (May 2019), the latest supported ScalaPB version of the gradle scalapb plugin is: 0.8.4
    compile "com.thesamet.scalapb:scalapb-runtime-grpc_2.12:0.8.4"
    compile 'io.grpc:grpc-netty:1.21.0'
}

apply plugin: 'application'

mainClassName = "spn_compiler.driver.Driver"
applicationName = 'spnc'

// Force proto compilation and perform thorough clean-up
compileScala.doFirst {
    scalapb.compileProtos()
    
    delete scalapb_absTargetDir + "/com", scalapb_absTargetDir + "/scalapb"
    ant.move(file: scalapb_absTargetDir, tofile: scalapb_absTargetDir + "/../..")
    delete scalapb_absTargetDir

    File targetDir = file(project.getProjectDir().absolutePath + "/target")
    delete targetDir.absolutePath + "/external_protos"
    if (targetDir.listFiles().length == 0) {
        delete targetDir
    }
}

task spnc(type: CreateStartScripts) {
    mainClassName = "spn_compiler.util.statistics.StatisticsMerger"
    classpath = startScripts.classpath
    outputDir = startScripts.outputDir
    applicationName = 'spn-statistics-merger'
}

applicationDistribution.into("bin") {
    duplicatesStrategy= DuplicatesStrategy.EXCLUDE
    from(spnc)
    fileMode = 0755
}
